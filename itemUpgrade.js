const upgradeDefinitions = {
  helms: {
    "Biggin's Bonnet": {
      exceptional: {
        name: "Biggin's Bonnet",
        base: "War Hat",
        properties: {
          defense: 53,
          reqstr: 20,
          reqlvl: 22,
        },
      },
      elite: {
        name: "Biggin's Bonnet",
        base: "Shako",
        properties: {
          defense: 141,
          reqstr: 50,
          reqlvl: 43,
        },
      },
    },
    Tarnhelm: {
      exceptional: {
        name: "Tarnhelm",
        base: "Sallet",
        properties: {
          defense: 62,
          reqstr: 43,
          reqlvl: 25,
        },
      },
      elite: {
        name: "Tarnhelm",
        base: "Hydraskull",
        properties: {
          defense: 145,
          reqstr: 84,
          reqlvl: 47,
        },
      },
    },
    "Coif of Glory": {
      exceptional: {
        name: "Coif of Glory",
        base: "Casque",
        properties: {
          defense: 82,
          reqstr: 59,
          reqlvl: 25,
        },
      },
      elite: {
        name: "Coif of Glory",
        base: "Armet",
        properties: {
          defense: 159,
          reqstr: 109,
          reqlvl: 51,
        },
      },
    },
    Duskeep: {
      exceptional: {
        name: "Duskeep",
        base: "Basinet",
        properties: {
          defense: 147,
          reqstr: 59,
          reqlvl: 25,
        },
      },
      elite: {
        name: "Duskeep",
        base: "Giant Conch",
        properties: {
          defense: 252,
          reqstr: 109,
          reqlvl: 40,
        },
      },
    },
    "The Face of Horror": {
      exceptional: {
        name: "The Face of Horror",
        base: "Death Mask",
        properties: {
          defense: 111,
          reqstr: 55,
          reqlvl: 25,
        },
      },
      elite: {
        name: "The Face of Horror",
        base: "Demonhead",
        properties: {
          defense: 179,
          reqstr: 102,
          reqlvl: 55,
        },
      },
    },
    "The Face of Horror": {
      exceptional: {
        name: "The Face of Horror",
        base: "Death Mask",
        properties: {
          defense: 111,
          reqstr: 55,
          reqlvl: 25,
        },
      },
      elite: {
        name: "The Face of Horror",
        base: "Demonhead",
        properties: {
          defense: 179,
          reqstr: 102,
          reqlvl: 55,
        },
      },
    },
    Wormskull: {
      exceptional: {
        name: "Wormskull",
        base: "Grim Helm",
        properties: {
          defense: 125,
          reqstr: 55,
          reqlvl: 25,
        },
      },
      elite: {
        name: "Wormskull",
        base: "Bone Visage",
        properties: {
          defense: 157,
          reqstr: 102,
          reqlvl: 63,
        },
      },
    },
    Howltusk: {
      exceptional: {
        name: "Howltusk",
        base: "Winged Helm",
        properties: {
          defense: 177,
          reqstr: 115,
          reqlvl: 25,
        },
      },
      elite: {
        name: "Howltusk",
        base: "Spired Helm",
        properties: {
          defense: 287,
          reqstr: 192,
          reqlvl: 59,
        },
      },
    },
    "Undead Crown": {
      exceptional: {
        name: "Undead Crown",
        base: "Grand Crown",
        properties: {
          defense: 153,
          reqstr: 103,
          reqlvl: 25,
        },
      },
      elite: {
        name: "Undead Crown",
        base: "Corona",
        properties: {
          defense: 195,
          reqstr: 174,
          reqlvl: 66,
        },
      },
    },
    "Peasant Crown": {
      exceptional: {
        name: "Peasant Crown",
        base: "War Hat",
        properties: {
          defense: 108,
          reqstr: 20,
          reqlvl: 28,
        },
      },
      elite: {
        name: "Peasant Crown",
        base: "Shako",
        properties: {
          defense: 100,
          reqstr: 150,
          reqlvl: 43,
        },
      },
    },
    Rockstopper: {
      exceptional: {
        name: "Rockstopper",
        base: "Sallet",
        properties: {
          defense: 84,
          reqstr: 20,
          reqlvl: 31,
        },
      },
      elite: {
        name: "Rockstopper",
        base: "Hydraskull",
        properties: {
          defense: 100,
          reqstr: 150,
          reqlvl: 47,
        },
      },
    },
    Stealskull: {
      exceptional: {
        name: "Stealskull",
        base: "Casque",
        properties: {
          defense: 244,
          reqstr: 59,
          reqlvl: 35,
        },
      },
      elite: {
        name: "Stealskull",
        base: "Armet",
        properties: {
          defense: 250,
          reqstr: 109,
          reqlvl: 51,
        },
      },
    },
    "Darksight Helm": {
      exceptional: {
        name: "Darksight Helm",
        base: "Basinet",
        properties: {
          defense: 84,
          reqstr: 82,
          reqlvl: 38,
        },
      },
      elite: {
        name: "Darksight Helm",
        base: "Giant Conch",
        properties: {
          defense: 154,
          reqstr: 142,
          reqlvl: 40,
        },
      },
    },
    "Blackhorn's Face": {
      exceptional: {
        name: "Blackhorn's Face",
        base: "Death Mask",
        properties: {
          defense: 278,
          reqstr: 55,
          reqlvl: 41,
        },
      },
      elite: {
        name: "Blackhorn's Face",
        base: "Bone Visage",
        properties: {
          defense: 100,
          reqstr: 106,
          reqlvl: 63,
        },
      },
    },
    "Valkyrie Wing": {
      exceptional: {
        name: "Valkyrie Wing",
        base: "Winged Helm",
        properties: {
          defense: 278,
          reqstr: 115,
          reqlvl: 44,
        },
      },
      elite: {
        name: "Valkyrie Wing",
        base: "Spired Helm",
        properties: {
          defense: 100,
          reqstr: 106,
          reqlvl: 59,
        },
      },
    },
    "Crown of Thieves": {
      exceptional: {
        name: "Crown of Thieves",
        base: "Grand Crown",
        properties: {
          defense: 278,
          reqstr: 103,
          reqlvl: 49,
        },
      },
      elite: {
        name: "Crown of Thieves",
        base: "Corona",
        properties: {
          defense: 100,
          reqstr: 106,
          reqlvl: 66,
        },
      },
    },
    "Cyclopean Roar": {
      exceptional: {
        name: "Cyclopean Roar",
        base: "Jawbone Visor",
        properties: {
          defense: 278,
          reqstr: 103,
          reqlvl: 28,
        },
      },
      elite: {
        name: "Cyclopean Roar",
        base: "Carnage Helm",
        properties: {
          defense: 100,
          reqstr: 106,
          reqlvl: 43,
        },
      },
    },
  },
  armors: {
    Greyform: {
      exceptional: {
        name: "Greyform",
        base: "Ghost Armor",
        properties: {
          defense: 278,
          reqstr: 103,
          reqlvl: 22,
        },
      },
      elite: {
        name: "Greyform",
        base: "Dusk Shroud",
        properties: {
          defense: 100,
          reqstr: 106,
          reqlvl: 49,
        },
      },
    },
    "Blinkbat's Form": {
      exceptional: {
        name: "Blinkbat's Form",
        base: "Serpentskin Armor",
        properties: {
          defense: 278,
          reqstr: 103,
          reqlvl: 24,
        },
      },
      elite: {
        name: "Blinkbat's Form",
        base: "Wyrmhide",
        properties: {
          defense: 100,
          reqstr: 106,
          reqlvl: 50,
        },
      },
    },
    "The Centurion": {
      exceptional: {
        name: "The Centurion",
        base: "Demonhide Armor",
        properties: {
          defense: 278,
          reqstr: 103,
          reqlvl: 25,
        },
      },
      elite: {
        name: "The Centurion",
        base: "Scarab Husk",
        properties: {
          defense: 100,
          reqstr: 106,
          reqlvl: 51,
        },
      },
    },
    Twitchthroe: {
      exceptional: {
        name: "Twitchthroe",
        base: "Trellised Armor",
        properties: {
          defense: 278,
          reqstr: 103,
          reqlvl: 25,
        },
      },
      elite: {
        name: "Twitchthroe",
        base: "Wire Fleece",
        properties: {
          defense: 100,
          reqstr: 106,
          reqlvl: 53,
        },
      },
    },
    Darkglow: {
      exceptional: {
        name: "Darkglow",
        base: "Linked Mail",
        properties: {
          defense: 278,
          reqstr: 103,
          reqlvl: 25,
        },
      },
      elite: {
        name: "Darkglow",
        base: "Diamond Mail",
        properties: {
          defense: 100,
          reqstr: 106,
          reqlvl: 54,
        },
      },
    },
    Hawkmail: {
      exceptional: {
        name: "Hawkmail",
        base: "Tigulated Mail",
        properties: {
          defense: 278,
          reqstr: 103,
          reqlvl: 25,
        },
      },
      elite: {
        name: "Hawkmail",
        base: "Loricated Mail",
        properties: {
          defense: 100,
          reqstr: 106,
          reqlvl: 55,
        },
      },
    },
    "Sparking Mail": {
      exceptional: {
        name: "Sparking Mail",
        base: "Mesh Armor",
        properties: {
          defense: 278,
          reqstr: 103,
          reqlvl: 25,
        },
      },
      elite: {
        name: "Sparking Mail",
        base: "Boneweave",
        properties: {
          defense: 100,
          reqstr: 106,
          reqlvl: 47,
        },
      },
    },
    "Venom Ward": {
      exceptional: {
        name: "Venom Ward",
        base: "Cuirass",
        properties: {
          defense: 278,
          reqstr: 103,
          reqlvl: 25,
        },
      },
      elite: {
        name: "Venom Ward",
        base: "Great Hauberk",
        properties: {
          defense: 100,
          reqstr: 106,
          reqlvl: 56,
        },
      },
    },
    Iceblink: {
      exceptional: {
        name: "Iceblink",
        base: "Russet Armor",
        properties: {
          defense: 278,
          reqstr: 103,
          reqlvl: 25,
        },
      },
      elite: {
        name: "Iceblink",
        base: "Balrog Skin",
        properties: {
          defense: 100,
          reqstr: 106,
          reqlvl: 57,
        },
      },
    },
    Boneflesh: {
      exceptional: {
        name: "Boneflesh",
        base: "Templar Coat",
        properties: {
          defense: 278,
          reqstr: 103,
          reqlvl: 25,
        },
      },
      elite: {
        name: "Boneflesh",
        base: "Hellforge Plate",
        properties: {
          defense: 100,
          reqstr: 106,
          reqlvl: 59,
        },
      },
    },
    Rockfleece: {
      exceptional: {
        name: "Rockfleece",
        base: "Sharktooth Armor",
        properties: {
          defense: 278,
          reqstr: 103,
          reqlvl: 25,
        },
      },
      elite: {
        name: "Rockfleece",
        base: "Kraken Shell",
        properties: {
          defense: 100,
          reqstr: 106,
          reqlvl: 61,
        },
      },
    },
    Rattlecage: {
      exceptional: {
        name: "Rattlecage",
        base: "Embossed Plate",
        properties: {
          defense: 278,
          reqstr: 103,
          reqlvl: 25,
        },
      },
      elite: {
        name: "Rattlecage",
        base: "Lacquered Plate",
        properties: {
          defense: 100,
          reqstr: 106,
          reqlvl: 62,
        },
      },
    },
    "Heavenly Garb": {
      exceptional: {
        name: "Heavenly Garb",
        base: "Mage Plate",
        properties: {
          defense: 278,
          reqstr: 103,
          reqlvl: 25,
        },
      },
      elite: {
        name: "Heavenly Garb",
        base: "Archon Plate",
        properties: {
          defense: 100,
          reqstr: 106,
          reqlvl: 63,
        },
      },
    },
    Goldskin: {
      exceptional: {
        name: "Goldskin",
        base: "Chaos Armor",
        properties: {
          defense: 278,
          reqstr: 103,
          reqlvl: 25,
        },
      },
      elite: {
        name: "Goldskin",
        base: "Shadow Plate",
        properties: {
          defense: 100,
          reqstr: 106,
          reqlvl: 64,
        },
      },
    },
    "Silks of the Victor": {
      exceptional: {
        name: "Silks of the Victor",
        base: "Ornate Plate",
        properties: {
          defense: 278,
          reqstr: 103,
          reqlvl: 25,
        },
      },
      elite: {
        name: "Silks of the Victor",
        base: "Sacred Armor",
        properties: {
          defense: 100,
          reqstr: 106,
          reqlvl: 66,
        },
      },
    },
  },
};

const baseDefenses = {
  Cap: 5,
  "Skull Cap": 11,
  Helm: 18,
  "Full Helm": 26,
  Mask: 27,
  "Bone Helm": 36,
  "Great Helm": 35,
  Crown: 45,
  "War Hat": 53,
  Shako: 141,
  Sallet: 62,
  Hydraskull: 145,
  Casque: 72,
  Basinet: 84,
  "Giant Conch": 154,
  Armet: 149,
  "Death Mask": 86,
  Demonhead: 154,
  "Grim Helm": 125,
  "Bone Visage": 157,
  "Winged Helm": 98,
  "Spired Helm": 159,
  "Grand Crown": 113,
  Corona: 165,
  "Jawbone Visor": 68,
  "Carnage Helm": 147,
  "Quilted Armor": 11,
  "Leather Armor": 17,
  "Hard Leather Armor": 25,
  "Studded Leather": 37,
  "Ring Mail": 51,
  "Scale Mail": 63,
  "Chain Mail": 71,
  "Breast Plate": 58,
  "Splint Mail": 84,
  "Plate Mail": 108,
  "Field Plate": 102,
  "Gothic Plate": 128,
  "Ghost Armor": 112,
  "Light Plate": 99,
  "Full Plate Mail": 150,
  "Ancient Armor": 185,
  "Serpentskin Armor": 122,
  "Trellised Armor": 156,
  "Demonhide Armor": 134,
  "Linked Mail": 180,
  "Tigulated Mail": 202,
  "Mesh Armor": 216,
  Cuirass: 176,
  "Russet Armor": 233,
  "Templar Coat": 278,
  "Sharktooth Armor": 255,
  "Embossed Plate": 304,
  "Mage Plate": 187,
  "Chaos Armor": 340,
  "Ornate Plate": 444,
  "Dusk Shroud": 302,
  Wyrmhide: 322,
  "Scarab Husk": 349,
  "Wire Fleece": 391,
  "Diamond Mail": 445,
  "Loricated Mail": 495,
  Boneweave: 489,
  "Great Hauberk": 420,
  "Balrog Skin": 541,
  "Hellforge Plate": 625,
  "Kraken Shell": 576,
  "Lacquered Plate": 664,
  "Archon Plate": 407,
  "Shadow Plate": 696,
  "Sacred Armor": 730,
};

const baseStrengths = {
  Cap: 0,
  "Skull Cap": 15,
  Helm: 26,
  "Full Helm": 41,
  Mask: 23,
  "Bone Helm": 25,
  "Great Helm": 63,
  Crown: 55,
  "War Hat": 20,
  Shako: 50,
  Sallet: 43,
  Hydraskull: 84,
  Casque: 59,
  Basinet: 82,
  "Giant Conch": 142,
  Armet: 109,
  "Death Mask": 55,
  Demonhead: 102,
  "Grim Helm": 58,
  "Bone Visage": 106,
  "Winged Helm": 115,
  "Spired Helm": 192,
  "Grand Crown": 103,
  Corona: 174,
  "Jawbone Visor": 58,
  "Carnage Helm": 106,
  "Quilted Armor": 12,
  "Leather Armor": 15,
  "Hard Leather Armor": 20,
  "Studded Leather": 27,
  "Ring Mail": 36,
  "Scale Mail": 44,
  "Chain Mail": 48,
  "Breast Plate": 30,
  "Splint Mail": 51,
  "Plate Mail": 65,
  "Field Plate": 55,
  "Gothic Plate": 70,
  "Light Plate": 41,
  "Full Plate Mail": 80,
  "Ancient Armor": 100,
  "Ghost Armor": 38,
  "Serpentskin Armor": 43,
  "Demonhide Armor": 50,
  "Trellised Armor": 61,
  "Linked Mail": 74,
  "Tigulated Mail": 86,
  "Mesh Armor": 92,
  Cuirass: 65,
  "Russet Armor": 97,
  "Templar Coat": 118,
  "Sharktooth Armor": 103,
  "Embossed Plate": 125,
  "Mage Plate": 55,
  "Chaos Armor": 140,
  "Ornate Plate": 170,
  "Dusk Shroud": 77,
  Wyrmhide: 84,
  "Scarab Husk": 95,
  "Wire Fleece": 111,
  "Diamond Mail": 131,
  "Loricated Mail": 149,
  Boneweave: 158,
  "Great Hauberk": 118,
  "Balrog Skin": 165,
  "Hellforge Plate": 196,
  "Kraken Shell": 174,
  "Lacquered Plate": 208,
  "Archon Plate": 103,
  "Shadow Plate": 220,
  "Sacred Armor": 232,
};

function buildDescription(itemName, baseType, properties, magicalProps) {
  return [
    itemName,
    baseType,
    `Defense: ${properties.defense}`,
    `Required Strength: ${properties.reqstr}`,
    `Required Level: ${properties.reqlvl}`,
    ...magicalProps
      .split("<br>")
      .filter(
        (prop) =>
          !prop.includes("Required") &&
          !prop.includes("Defense:") &&
          prop.trim() !== itemName &&
          prop.trim() !== baseType
      ),
  ].join("<br>");
}

function calculateItemDefense(item, baseType) {
  const baseDefense = baseDefenses[baseType] || 0;
  const { edef, todef } = item.properties || {};

  let socketsEDef = 0;
  document
    .querySelectorAll(
      '.socketz[data-section="helm"], .socketz[data-section="armor"]'
    )
    .forEach((socket) => {
      if (socket.dataset.itemName && socket.dataset.stats) {
        const edefMatch = socket.dataset.stats.match(
          /\+(\d+)% Enhanced Defense/
        );
        if (edefMatch) socketsEDef += parseInt(edefMatch[1]);
      }
    });

  if (!edef && !todef) return Math.floor(baseDefense * (1 + socketsEDef / 100));
  if (!edef && todef)
    return Math.floor(baseDefense * (1 + socketsEDef / 100)) + todef;

  const totalEdef = (edef + socketsEDef) / 100;
  return todef
    ? Math.floor(baseDefense * (1 + totalEdef)) + todef
    : Math.floor(baseDefense * (1 + totalEdef));
}

function handleUpgrade() {
  const select = document.getElementById("helms-dropdown");
  const currentItem = select.value;
  const upgrades = upgradeDefinitions.helms[currentItem];
  const currentItemData = itemList[currentItem];

  if (!upgrades) return;

  const level = parseInt(document.getElementById("lvlValue").value) || 0;
  const str = parseInt(document.getElementById("str").value) || 0;
  const baseType = currentItemData.description.split("<br>")[1];

  if (baseType === upgrades.elite.base) {
    alert("Item is already at maximum upgrade level");
    return;
  }

  const magicalProperties = currentItemData.description
    .split("<br>")
    .slice(3)
    .filter((prop) => !prop.includes("Required") && !prop.includes("Defense:"))
    .join("<br>");

  if (baseType === upgrades.exceptional.base) {
    if (
      level >= upgrades.elite.properties.reqlvl &&
      str >= baseStrengths[upgrades.elite.base]
    ) {
      const newProperties = {
        ...upgrades.elite.properties,
        defense: calculateItemDefense(currentItemData, upgrades.elite.base),
        reqstr: baseStrengths[upgrades.elite.base],
      };

      itemList[currentItem] = {
        description: buildDescription(
          currentItem,
          upgrades.elite.base,
          newProperties,
          magicalProperties
        ),
        properties: { ...currentItemData.properties, ...newProperties },
      };

      select.dispatchEvent(new Event("change"));
      alert("Item upgraded to elite version!");
      return;
    }
  } else {
    if (
      level >= upgrades.exceptional.properties.reqlvl &&
      str >= baseStrengths[upgrades.exceptional.base]
    ) {
      const newProperties = {
        ...upgrades.exceptional.properties,
        defense: calculateItemDefense(
          currentItemData,
          upgrades.exceptional.base
        ),
        reqstr: baseStrengths[upgrades.exceptional.base],
      };

      itemList[currentItem] = {
        description: buildDescription(
          currentItem,
          upgrades.exceptional.base,
          newProperties,
          magicalProperties
        ),
        properties: { ...currentItemData.properties, ...newProperties },
      };

      select.dispatchEvent(new Event("change"));
      alert("Item upgraded to exceptional version!");
      return;
    }
  }

  alert("Character does not meet requirements for upgrade");
}

function handleArmorUpgrade() {
  const select = document.getElementById("armors-dropdown");
  const currentItem = select.value;
  const upgrades = upgradeDefinitions.armors[currentItem];
  const currentItemData = itemList[currentItem];

  if (!upgrades) return;

  const level = parseInt(document.getElementById("lvlValue").value) || 0;
  const str = parseInt(document.getElementById("str").value) || 0;
  const baseType = currentItemData.description.split("<br>")[1];

  if (baseType === upgrades.elite.base) {
    alert("Item is already at maximum upgrade level");
    return;
  }

  const magicalProperties = currentItemData.description
    .split("<br>")
    .slice(3)
    .filter((prop) => !prop.includes("Required") && !prop.includes("Defense:"))
    .join("<br>");

  if (baseType === upgrades.exceptional.base) {
    if (
      level >= upgrades.elite.properties.reqlvl &&
      str >= baseStrengths[upgrades.elite.base]
    ) {
      const newProperties = {
        ...upgrades.elite.properties,
        defense: calculateItemDefense(currentItemData, upgrades.elite.base),
        reqstr: baseStrengths[upgrades.elite.base],
      };

      itemList[currentItem] = {
        description: buildDescription(
          currentItem,
          upgrades.elite.base,
          newProperties,
          magicalProperties
        ),
        properties: { ...currentItemData.properties, ...newProperties },
      };

      select.dispatchEvent(new Event("change"));
      alert("Item upgraded to elite version!");
      return;
    }
  } else {
    if (
      level >= upgrades.exceptional.properties.reqlvl &&
      str >= baseStrengths[upgrades.exceptional.base]
    ) {
      const newProperties = {
        ...upgrades.exceptional.properties,
        defense: calculateItemDefense(
          currentItemData,
          upgrades.exceptional.base
        ),
        reqstr: baseStrengths[upgrades.exceptional.base],
      };

      itemList[currentItem] = {
        description: buildDescription(
          currentItem,
          upgrades.exceptional.base,
          newProperties,
          magicalProperties
        ),
        properties: { ...currentItemData.properties, ...newProperties },
      };

      select.dispatchEvent(new Event("change"));
      alert("Item upgraded to exceptional version!");
      return;
    }
  }

  alert("Character does not meet requirements for upgrade");
}

function updateDefense() {
  const helmSelect = document.getElementById("helms-dropdown");
  const armorSelect = document.getElementById("armors-dropdown");

  [helmSelect, armorSelect].forEach((select) => {
    if (!select?.value) return;
    const item = itemList[select.value];
    if (!item) return;

    const baseType = item.description.split("<br>")[1];
    const newDefense = calculateItemDefense(item, baseType);

    if (newDefense !== item.properties.defense) {
      const lines = item.description.split("<br>");
      const defenseIndex = lines.findIndex((line) =>
        line.startsWith("Defense:")
      );
      lines[defenseIndex] = `Defense: ${newDefense}`;
      item.description = lines.join("<br>");
      item.properties.defense = newDefense;
      select.dispatchEvent(new Event("change"));
    }
  });
}

document.addEventListener("DOMContentLoaded", () => {
  document
    .querySelectorAll(
      '.socketz[data-section="helm"], .socketz[data-section="armor"]'
    )
    .forEach((socket) => {
      new MutationObserver(() => requestAnimationFrame(updateDefense)).observe(
        socket,
        {
          attributes: true,
          childList: true,
          subtree: true,
          characterData: true,
        }
      );
    });

  ["str", "dex", "vit", "enr", "lvlValue"].forEach((id) => {
    document.getElementById(id)?.addEventListener("input", updateDefense);
  });

  ["helms-dropdown", "armors-dropdown"].forEach((id) => {
    document.getElementById(id)?.addEventListener("change", updateDefense);
  });
});
