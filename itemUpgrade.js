const upgradeDefinitions = {
  helms: {
    "Biggin's Bonnet": {
      exceptional: {
        name: "Biggin's Bonnet",
        base: "War Hat",
        properties: {
          defense: 53,
          reqstr: 20,
          reqlvl: 22,
        },
      },
      elite: {
        name: "Biggin's Bonnet",
        base: "Shako",
        properties: {
          defense: 141,
          reqstr: 50,
          reqlvl: 43,
        },
      },
    },
    Tarnhelm: {
      exceptional: {
        name: "Tarnhelm",
        base: "Sallet",
        properties: {
          defense: 62,
          reqstr: 43,
          reqlvl: 25,
        },
      },
      elite: {
        name: "Tarnhelm",
        base: "Hydraskull",
        properties: {
          defense: 145,
          reqstr: 84,
          reqlvl: 47,
        },
      },
    },
    "Coif of Glory": {
      exceptional: {
        name: "Coif of Glory",
        base: "Casque",
        properties: {
          defense: 82,
          reqstr: 59,
          reqlvl: 25,
        },
      },
      elite: {
        name: "Coif of Glory",
        base: "Armet",
        properties: {
          defense: 159,
          reqstr: 109,
          reqlvl: 51,
        },
      },
    },
    Duskeep: {
      exceptional: {
        name: "Duskeep",
        base: "Basinet",
        properties: {
          defense: 147,
          reqstr: 59,
          reqlvl: 25,
        },
      },
      elite: {
        name: "Duskeep",
        base: "Giant Conch",
        properties: {
          defense: 252,
          reqstr: 109,
          reqlvl: 40,
        },
      },
    },
    "The Face of Horror": {
      exceptional: {
        name: "The Face of Horror",
        base: "Death Mask",
        properties: {
          defense: 111,
          reqstr: 55,
          reqlvl: 25,
        },
      },
      elite: {
        name: "The Face of Horror",
        base: "Demonhead",
        properties: {
          defense: 179,
          reqstr: 102,
          reqlvl: 55,
        },
      },
    },
    "The Face of Horror": {
      exceptional: {
        name: "The Face of Horror",
        base: "Death Mask",
        properties: {
          defense: 111,
          reqstr: 55,
          reqlvl: 25,
        },
      },
      elite: {
        name: "The Face of Horror",
        base: "Demonhead",
        properties: {
          defense: 179,
          reqstr: 102,
          reqlvl: 55,
        },
      },
    },
    Wormskull: {
      exceptional: {
        name: "Wormskull",
        base: "Grim Helm",
        properties: {
          defense: 125,
          reqstr: 55,
          reqlvl: 25,
        },
      },
      elite: {
        name: "Wormskull",
        base: "Bone Visage",
        properties: {
          defense: 157,
          reqstr: 102,
          reqlvl: 63,
        },
      },
    },
    Howltusk: {
      exceptional: {
        name: "Howltusk",
        base: "Winged Helm",
        properties: {
          defense: 177,
          reqstr: 115,
          reqlvl: 25,
        },
      },
      elite: {
        name: "Howltusk",
        base: "Spired Helm",
        properties: {
          defense: 287,
          reqstr: 192,
          reqlvl: 59,
        },
      },
    },
    "Undead Crown": {
      exceptional: {
        name: "Undead Crown",
        base: "Grand Crown",
        properties: {
          defense: 153,
          reqstr: 103,
          reqlvl: 25,
        },
      },
      elite: {
        name: "Undead Crown",
        base: "Corona",
        properties: {
          defense: 195,
          reqstr: 174,
          reqlvl: 66,
        },
      },
    },
    "Peasant Crown": {
      exceptional: {
        name: "Peasant Crown",
        base: "War Hat",
        properties: {
          defense: 108,
          reqstr: 20,
          reqlvl: 28,
        },
      },
      elite: {
        name: "Peasant Crown",
        base: "Shako",
        properties: {
          defense: 100,
          reqstr: 150,
          reqlvl: 43,
        },
      },
    },
    Rockstopper: {
      exceptional: {
        name: "Rockstopper",
        base: "Sallet",
        properties: {
          defense: 84,
          reqstr: 20,
          reqlvl: 31,
        },
      },
      elite: {
        name: "Rockstopper",
        base: "Hydraskull",
        properties: {
          defense: 100,
          reqstr: 150,
          reqlvl: 47,
        },
      },
    },
    Stealskull: {
      exceptional: {
        name: "Stealskull",
        base: "Casque",
        properties: {
          defense: 244,
          reqstr: 59,
          reqlvl: 35,
        },
      },
      elite: {
        name: "Stealskull",
        base: "Armet",
        properties: {
          defense: 250,
          reqstr: 109,
          reqlvl: 51,
        },
      },
    },
    "Darksight Helm": {
      exceptional: {
        name: "Darksight Helm",
        base: "Basinet",
        properties: {
          defense: 84,
          reqstr: 82,
          reqlvl: 38,
        },
      },
      elite: {
        name: "Darksight Helm",
        base: "Giant Conch",
        properties: {
          defense: 154,
          reqstr: 142,
          reqlvl: 40,
        },
      },
    },
    "Blackhorn's Face": {
      exceptional: {
        name: "Blackhorn's Face",
        base: "Death Mask",
        properties: {
          defense: 278,
          reqstr: 55,
          reqlvl: 41,
        },
      },
      elite: {
        name: "Blackhorn's Face",
        base: "Bone Visage",
        properties: {
          defense: 100,
          reqstr: 106,
          reqlvl: 63,
        },
      },
    },
    "Valkyrie Wing": {
      exceptional: {
        name: "Valkyrie Wing",
        base: "Winged Helm",
        properties: {
          defense: 278,
          reqstr: 115,
          reqlvl: 44,
        },
      },
      elite: {
        name: "Valkyrie Wing",
        base: "Spired Helm",
        properties: {
          defense: 100,
          reqstr: 106,
          reqlvl: 59,
        },
      },
    },
    "Crown of Thieves": {
      exceptional: {
        name: "Crown of Thieves",
        base: "Grand Crown",
        properties: {
          defense: 278,
          reqstr: 103,
          reqlvl: 49,
        },
      },
      elite: {
        name: "Crown of Thieves",
        base: "Corona",
        properties: {
          defense: 100,
          reqstr: 106,
          reqlvl: 66,
        },
      },
    },
  },
};

const baseDefenses = {
  Cap: 5,
  "Skull Cap": 11,
  Helm: 18,
  "Full Helm": 26,
  Mask: 27,
  "Bone Helm": 36,
  "Great Helm": 35,
  Crown: 45,
  "War Hat": 53,
  Shako: 141,
  Sallet: 62,
  Hydraskull: 145,
  Casque: 72,
  Basinet: 84,
  "Giant Conch": 154,
  Armet: 149,
  "Death Mask": 86,
  Demonhead: 154,
  "Grim Helm": 125,
  "Bone Visage": 157,
  "Winged Helm": 98,
  "Spired Helm": 159,
  "Grand Crown": 113,
  Corona: 165,
};

const baseStrengths = {
  Cap: 0,
  "Skull Cap": 15,
  Helm: 26,
  "Full Helm": 41,
  Mask: 23,
  "Bone Helm": 25,
  "Great Helm": 63,
  Crown: 55,
  "War Hat": 20,
  Shako: 50,
  Sallet: 43,
  Hydraskull: 84,
  Casque: 59,
  Basinet: 82,
  "Giant Conch": 142,
  Armet: 109,
  "Death Mask": 55,
  Demonhead: 102,
  "Grim Helm": 58,
  "Bone Visage": 106,
  "Winged Helm": 115,
  "Spired Helm": 192,
  "Grand Crown": 103,
  Corona: 174,
};

function buildDescription(itemName, baseType, properties, magicalProps) {
  return [
    itemName,
    baseType,
    `Defense: ${properties.defense}`,
    `Required Strength: ${properties.reqstr}`,
    `Required Level: ${properties.reqlvl}`,
    ...magicalProps
      .split("<br>")
      .filter(
        (prop) =>
          !prop.includes("Required") &&
          !prop.includes("Defense:") &&
          prop.trim() !== itemName &&
          prop.trim() !== baseType
      ),
  ].join("<br>");
}

function calculateItemDefense(item, baseType) {
  const baseDefense = baseDefenses[baseType] || 0;
  const { edef, todef } = item.properties || {};

  let socketsEDef = 0;
  document
    .querySelectorAll('.socketz[data-section="helm"]')
    .forEach((socket) => {
      if (socket.dataset.itemName && socket.dataset.stats) {
        const edefMatch = socket.dataset.stats.match(
          /\+(\d+)% Enhanced Defense/
        );
        if (edefMatch) socketsEDef += parseInt(edefMatch[1]);
      }
    });

  if (!edef && !todef) return Math.floor(baseDefense * (1 + socketsEDef / 100));
  if (!edef && todef)
    return Math.floor(baseDefense * (1 + socketsEDef / 100)) + todef;

  // Include item's edef in calculation
  const totalEdef = (edef + socketsEDef) / 100;
  return todef
    ? Math.floor(baseDefense * (1 + totalEdef)) + todef
    : Math.floor(baseDefense * (1 + totalEdef));
}

function extractEnhancedDefense() {
  const enhancedDefense = {};

  Object.entries(itemList).forEach(([itemName, item]) => {
    if (item.properties.edef) {
      enhancedDefense[itemName] = item.properties.edef;
    }
  });

  return enhancedDefense;
}

const enhancedDefense = extractEnhancedDefense();
console.log(enhancedDefense);

function handleUpgrade() {
  const select = document.getElementById("helms-dropdown");
  const currentItem = select.value;
  const upgrades = upgradeDefinitions.helms[currentItem];
  const currentItemData = itemList[currentItem];

  if (!upgrades) return;

  const level = parseInt(document.getElementById("lvlValue").value) || 0;
  const str = parseInt(document.getElementById("str").value) || 0;

  // Get base type from description
  const baseType = currentItemData.description.split("<br>")[1];

  // Check if item is already elite
  if (baseType === upgrades.elite.base) {
    alert("Item is already at maximum upgrade level");
    return;
  }

  const magicalProperties = currentItemData.description
    .split("<br>")
    .slice(3)
    .filter((prop) => !prop.includes("Required") && !prop.includes("Defense:"))
    .join("<br>");

  // Check if exceptional and try elite upgrade
  if (baseType === upgrades.exceptional.base) {
    if (
      level >= upgrades.elite.properties.reqlvl &&
      str >= baseStrengths[upgrades.elite.base]
    ) {
      const newProperties = {
        ...upgrades.elite.properties,
        defense: calculateItemDefense(currentItemData, upgrades.elite.base),
        reqstr: baseStrengths[upgrades.elite.base],
      };

      itemList[currentItem] = {
        description: buildDescription(
          currentItem,
          upgrades.elite.base,
          newProperties,
          magicalProperties
        ),
        properties: { ...currentItemData.properties, ...newProperties },
      };

      select.dispatchEvent(new Event("change"));
      alert("Item upgraded to elite version!");
      return;
    }
  } else {
    // Try exceptional upgrade
    if (
      level >= upgrades.exceptional.properties.reqlvl &&
      str >= baseStrengths[upgrades.exceptional.base]
    ) {
      const newProperties = {
        ...upgrades.exceptional.properties,
        defense: calculateItemDefense(
          currentItemData,
          upgrades.exceptional.base
        ),
        reqstr: baseStrengths[upgrades.exceptional.base],
      };

      itemList[currentItem] = {
        description: buildDescription(
          currentItem,
          upgrades.exceptional.base,
          newProperties,
          magicalProperties
        ),
        properties: { ...currentItemData.properties, ...newProperties },
      };

      select.dispatchEvent(new Event("change"));
      alert("Item upgraded to exceptional version!");
      return;
    }
  }

  alert("Character does not meet requirements for upgrade");
}

document.addEventListener("DOMContentLoaded", () => {
  const observer = new MutationObserver(updateDefense);
  document
    .querySelectorAll('.socketz[data-section="helm"]')
    .forEach((socket) => {
      observer.observe(socket, {
        attributes: true,
        childList: true,
        subtree: true,
      });
    });

  ["str", "dex", "vit", "enr", "lvlValue"].forEach((id) => {
    document.getElementById(id)?.addEventListener("input", updateDefense);
  });

  document
    .getElementById("helms-dropdown")
    ?.addEventListener("change", updateDefense);
});

function updateDefense() {
  const select = document.getElementById("helms-dropdown");
  const item = itemList[select?.value];
  if (!item) return;

  const baseType = item.description.split("<br>")[1];
  const newDefense = calculateItemDefense(item, baseType);

  if (newDefense !== item.properties.defense) {
    const lines = item.description.split("<br>");
    const defenseIndex = lines.findIndex((line) => line.startsWith("Defense:"));
    lines[defenseIndex] = `Defense: ${newDefense}`;
    item.description = lines.join("<br>");
    item.properties.defense = newDefense;
    select.dispatchEvent(new Event("change"));
  }
}

// Add listeners for both sockets and inventory changes
document.addEventListener("DOMContentLoaded", () => {
  // Socket mutation observer
  document
    .querySelectorAll('.socketz[data-section="helm"]')
    .forEach((socket) => {
      new MutationObserver(() => requestAnimationFrame(updateDefense)).observe(
        socket,
        {
          attributes: true,
          childList: true,
          subtree: true,
          characterData: true,
        }
      );
    });

  // Stats and level changes
  ["str", "dex", "vit", "enr", "lvlValue"].forEach((id) => {
    document.getElementById(id)?.addEventListener("input", updateDefense);
  });

  // Item selection changes
  document
    .getElementById("helms-dropdown")
    ?.addEventListener("change", updateDefense);
});
